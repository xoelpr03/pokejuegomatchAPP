<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shiny Match</title>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-main: #1e293b;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --shiny-gold: #fbbf24;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%);
            color: #f8fafc;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
        }

        /* --- MENU STYLES --- */
        .menu-card {
            background: var(--card-bg);
            width: 90%;
            max-width: 350px;
            padding: 30px 20px;
            border-radius: 24px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            text-align: center;
            color: var(--text-main);
            z-index: 100;
        }

        .menu-title {
            font-size: 28px; font-weight: 900; margin: 10px 0 5px 0; text-transform: uppercase;
            background: linear-gradient(135deg, #ef4444 0%, #3b82f6 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .btn-group { display: flex; flex-direction: column; gap: 12px; }

        .menu-btn {
            width: 100%; height: 50px; border-radius: 12px; font-size: 14px; font-weight: 800;
            cursor: pointer; border: none; text-transform: uppercase; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; text-decoration: none;
            -webkit-tap-highlight-color: transparent;
        }

        .mode-play { background: #3b82f6; color: white; font-size: 18px; }
        .mode-how { background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; }
        .mode-dex { background: #fbbf24; color: #78350f; }
        .exit-link-btn { background: #64748b; color: white; }

        .mute-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white; border: 1px solid rgba(255, 255, 255, 0.2);
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; transition: 0.3s;
        }
        .mute-btn.active { background: var(--danger); border-color: transparent; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            color: var(--text-main);
            width: min(90vw, 520px);
            max-height: 80vh;
            padding: clamp(18px, 4vw, 30px);
            border-radius: 20px;
            text-align: center;
            overflow: hidden;
        }

        #dex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(56px, 1fr));
            gap: clamp(6px, 1.5vw, 10px);
            max-height: 45vh;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 12px;
        }

        .dex-slot {
            aspect-ratio: 1;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            position: relative;
            padding: clamp(4px, 0.8vw, 8px);
        }

        .dex-img {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        .dex-slot.not-caught .dex-img {
            filter: brightness(0);
            opacity: 0.2;
        }

        .dex-num {
            position: absolute;
            top: 2px;
            left: 3px;
            font-size: 8px;
            font-weight: 900;
            color: #cbd5e1;
        }

        /* --- GAME SCREEN --- */
        #game-screen { 
            display: none; 
            flex-direction: column;
            align-items: center;
            width: 95vw; 
            max-width: 500px; 
            max-height: 98vh;
            padding: 10px; 
            box-sizing: border-box;
            position: relative;
        }

        #game-over-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 24px;
            animation: fadeIn 0.3s ease;
            text-align: center;
            padding: 20px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        #score-box { text-align: left; }
        #score-label { font-size: 10px; color: #94a3b8; font-weight: 800; }
        #score { font-size: 28px; font-weight: 900; color: #fbbf24; line-height: 1; }

        canvas {
    width: 100%;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    background: #1e293b; 
    border: 4px solid #475569;
    border-radius: 18px; 
    image-rendering: pixelated;
    touch-action: none; 
    cursor: crosshair;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

        #shiny-tracker {
            margin-top: 10px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 8px;
            min-height: 50px;
            overflow-y: auto;
        }
        #shiny-label { font-size: 10px; color: #94a3b8; font-weight: 800; text-align: left; margin-bottom: 5px;}
        #shiny-list, #final-shiny-list { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }

        .shiny-icon { 
            width: 35px; 
            height: 35px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 8px; 
            image-rendering: pixelated; 
        }

        #status { font-size: 12px; color: #fbbf24; margin-top: 5px; font-weight: 800; height: 15px; text-transform: uppercase; }
        
        #loading-msg { 
            position: fixed; inset: 0; background: #0f172a; 
            display: none; align-items: center; justify-content: center; 
            z-index: 2000; font-weight: 900; letter-spacing: 2px;
        }

        .creator-credit {
            margin-top: 25px; font-size: 9px; font-weight: 800; text-transform: lowercase;
            letter-spacing: 2px; color: #94a3b8; opacity: 0.6; text-align: center;
            border-top: 1px solid #e2e8f0; padding-top: 12px; width: 180px; margin: 25px auto 0;
        }

        .shiny-alert { animation: rainbow 1.5s infinite; }
        @keyframes rainbow {
            0% { color: #f87171; } 25% { color: #facc15; } 50% { color: #34d399; } 75% { color: #60a5fa; } 100% { color: #f87171; }
        }

        #who-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    max-height: 45vh;
    overflow-y: auto;
    margin: 15px 0;
    padding: 10px;
    background: #f1f5f9;
    border-radius: 12px;
}

.who-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    padding: 8px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

.who-name {
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--accent);
    margin-top: 4px;
}

.quit-btn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    transition: 0.3s;
    outline: none;
}

.quit-btn:hover {
    background: rgba(239, 68, 68, 0.25);
    border-color: rgba(239, 68, 68, 0.6);
    transform: scale(1.08);
}

.quit-btn:active {
    transform: scale(0.95);
}

#gameCanvas {
    touch-action: none; /* Esto es vital para que el swipe funcione en m√≥viles */
}

    </style>
</head>
<body>

    <div id="loading-msg">FETCHING POK√âMON...</div>

    <div id="how-to-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: var(--accent); margin-top: 0;">How to Play</h3>
            <ul style="font-size: 14px; line-height: 1.6; text-align: left; padding-left: 20px;">
                <li><strong>Swipe</strong> to match 3 or more Pok√©mon.</li>
                <li><strong>Normal Match:</strong> 100 points per tile.</li>
                <li><strong>Shiny Match:</strong> 2,000 points per tile!</li>
                <li><strong>Shiny Hunt:</strong> 1/100 chance per spawn.</li>
            </ul>
            <button class="menu-btn mode-play" onclick="closeModals()">GOT IT!</button>
        </div>
    </div>

    <div id="dex-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: var(--shiny-gold); margin-top: 0;">‚ú® SHINY POK√âDEX ‚ú®</h3>
            <p id="dex-count" style="font-size: 12px; font-weight: 800; color: #64748b;"></p>
            <div id="dex-grid"></div>
            <button class="menu-btn exit-link-btn" onclick="closeModals()">CLOSE</button>
        </div>
    </div>

    <div id="main-menu" class="menu-card">
        <div style="font-size: 50px; margin-bottom: 10px;">‚ú®</div>
        <h1 class="menu-title">Shiny Match</h1>
        <p style="font-size: 11px; margin-bottom: 20px; font-weight: 600; color: #64748b;">SHINY ODDS: 1/100</p>
        <div class="btn-group">
            <button class="menu-btn mode-play" onclick="startGame()">Start Hunt</button>
            <button id="continue-btn" class="menu-btn mode-play" style="background: #10b981; display: none;" onclick="continueGame()">Continue Hunting</button>
            <button class="menu-btn mode-dex" onclick="openDex()">Shiny Pokedex</button>
            <button class="menu-btn mode-how" onclick="openHow()">How to Play</button>
        </div>
        <div class="creator-credit">created by ŒæawsjŒ±ke</div>
    </div>

    <div id="game-screen">
        <div id="game-over-overlay">
            <h2 style="color: var(--danger); font-size: 40px; margin-bottom: 5px; font-weight: 900;">GAME OVER</h2>
            <p style="font-size: 20px; font-weight: 800; margin-bottom: 10px;">SCORE: <span id="final-streak">0</span></p>
            
            <div id="game-over-shinies" style="margin-bottom: 20px;">
                <div style="font-size: 10px; color: #94a3b8; font-weight: 800; margin-bottom: 10px;">SHINIES COLLECTED</div>
                <div id="final-shiny-list"></div>
            </div>

            <div class="btn-group" style="width: 220px;">
                <button class="menu-btn mode-play" onclick="startGame()">Try Again</button>
                <button class="menu-btn exit-link-btn" onclick="resetToMenu()">Main Menu</button>
            </div>
        </div>

        <div id="header">
            <div id="score-box">
                <div id="score-label">SCORE</div>
                <div id="score">0</div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div id="who-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color: var(--accent); margin-top: 0;">Who's That Pok√©mon?</h3>
        <div id="who-grid"></div>
        <button class="menu-btn mode-play" onclick="closeModals()">BACK TO HUNT</button>
    </div>
</div>
<button class="menu-btn mode-dex" style="width: 40px; height: 40px; border-radius: 50%; font-size: 18px;" onclick="openWho()">‚ùì</button>
                <button id="muteBtn" class="mute-btn" onclick="toggleMute()">üîä</button>
                <button class="quit-btn" onclick="quitAndSave()">‚úï</button>
        
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
        <div id="status">SWIPE TO MATCH</div>

        <div id="shiny-tracker">
            <div id="shiny-label">SHINIES CAPTURED</div>
            <div id="shiny-list"></div>
        </div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const statusEl = document.getElementById('status');
const loadingEl = document.getElementById('loading-msg');
const mainMenu = document.getElementById('main-menu');
const gameScreen = document.getElementById('game-screen');
const gameOverOverlay = document.getElementById('game-over-overlay');
const finalScoreEl = document.getElementById('final-streak');
const shinyListEl = document.getElementById('shiny-list');
const finalShinyListEl = document.getElementById('final-shiny-list');
const muteBtn = document.getElementById('muteBtn');
const whoModal = document.getElementById('who-modal');
const whoGrid = document.getElementById('who-grid');
const howModal = document.getElementById('how-to-modal');
const dexModal = document.getElementById('dex-modal');
const dexGrid = document.getElementById('dex-grid');
const dexCount = document.getElementById('dex-count');

const SHINY_SOUND = new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3');
SHINY_SOUND.volume = 1;

let isMuted = false;
const GRID_SIZE = 7; 
const SHINY_CHANCE = 100;
let TILE_SIZE = 0;
let board = [];
let score = 0;
let isAnimating = false;
let gameOver = false;
let lastMoveTime = Date.now();
let gameInitialized = false;
let startX = null, startY = null;
let sparkles = [];
let pokemonData = [];
let pokemonColors = [];
const colors = ["#ef4444", "#f97316", "#eab308", "#22c55e", "#06b6d4", "#ec4899"];
const REGIONAL_IDS = [10091, 10100, 10101, 10102, 10103, 10104, 10105, 10106, 10107, 10108, 10109, 10110, 10111, 10112, 10113, 10114, 10115, 10161, 10162, 10163, 10164, 10165, 10166, 10167, 10168, 10169, 10170, 10171, 10172, 10173, 10174, 10175, 10176, 10177, 10179, 10180, 10229, 10230, 10231, 10232, 10233, 10234, 10235, 10236, 10237, 10238, 10239, 10240, 10241, 10242, 10243, 10244, 10250, 10253];

let caughtShinies = JSON.parse(localStorage.getItem('shinyDex')) || {};

// Configuraci√≥n de entrada y prevenci√≥n de scroll
canvas.style.touchAction = 'none';
canvas.style.userSelect = 'none';

// --- SISTEMA DE GUARDADO Y CONTINUACI√ìN ---

function checkSaveFile() {
    const save = localStorage.getItem('shinyMatchSave');
    const continueBtn = document.getElementById('continue-btn');
    if (continueBtn) continueBtn.style.display = save ? 'flex' : 'none';
}
function openWho() {
    whoGrid.innerHTML = "";

    pokemonData.forEach(p => {
        const item = document.createElement('div');
        item.className = 'who-item';

        const img = document.createElement('img');
        img.src = p.images.normal.src;
        img.style.width = "64px";
        img.style.imageRendering = "pixelated";

        const name = document.createElement('div');
        name.className = 'who-name';
        name.textContent = p.name;

        item.appendChild(img);
        item.appendChild(name);
        whoGrid.appendChild(item);
    });

    whoModal.style.display = 'flex';
}
function saveGameState() {
    if (gameOver || pokemonData.length === 0) return;
    const gameState = {
        board: board,
        score: score,
        pokemonData: pokemonData.map(p => ({
            id: p.id,
            name: p.name,
            normalSrc: p.images.normal.src,
            shinySrc: p.images.shiny.src,
            cry: p.cry
        })),
        pokemonColors: pokemonColors,
        shinyTrackerHTML: shinyListEl.innerHTML
    };
    localStorage.setItem('shinyMatchSave', JSON.stringify(gameState));
    checkSaveFile();
}

function quitAndSave() {
    saveGameState();
    resetToMenu();
}

async function continueGame() {
    const rawData = localStorage.getItem('shinyMatchSave');
    if (!rawData) return;
    const savedData = JSON.parse(rawData);

    mainMenu.style.display = 'none';
    gameScreen.style.display = 'flex';
    loadingEl.style.display = 'flex';

    score = savedData.score;
    scoreEl.innerText = score;
    pokemonColors = savedData.pokemonColors;
    shinyListEl.innerHTML = savedData.shinyTrackerHTML;

    // Recargar im√°genes para el canvas
    pokemonData = [];
    for (const p of savedData.pokemonData) {
        const normal = new Image();
        const shiny = new Image();
        normal.crossOrigin = "anonymous";
        shiny.crossOrigin = "anonymous";
        normal.src = p.normalSrc;
        shiny.src = p.shinySrc;
        await Promise.all([
            new Promise(r => normal.onload = r), 
            new Promise(r => shiny.onload = r)
        ]);
        pokemonData.push({ id: p.id, name: p.name, images: { normal, shiny }, cry: p.cry });
    }

    board = savedData.board;
    resize(); // Ajustar tama√±o al cargar
    loadingEl.style.display = 'none';

    if(!gameInitialized) {
        gameInitialized = true;
        requestAnimationFrame(renderLoop);
        setInterval(checkIdleTime, 1000);
    }
}

// --- L√ìGICA DEL JUEGO ---

async function fetchGameData() {
    try {
        const selectedIds = new Set();
        const ALL_IDS = [...Array.from({length: 1025}, (_, i) => i + 1), ...REGIONAL_IDS];
        const missingShinyIds = ALL_IDS.filter(id => !caughtShinies[id]);

        while (selectedIds.size < 6) {
            let id = (missingShinyIds.length > 0 && Math.random() < 0.7) 
                ? missingShinyIds.splice(Math.floor(Math.random() * missingShinyIds.length), 1)[0]
                : ALL_IDS[Math.floor(Math.random() * ALL_IDS.length)];
            selectedIds.add(id);
        }

        const idArray = Array.from(selectedIds);
        for(let i=0; i < 6; i++) {
            let fetchId = idArray[i];
            const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${fetchId}`);
            const data = await res.json();
            const normal = new Image();
            const shiny = new Image();
            const pName = data.name.split('-')[0];
            normal.crossOrigin = "anonymous";
            shiny.crossOrigin = "anonymous";
            normal.src = data.sprites.front_default || data.sprites.other['official-artwork'].front_default;
            shiny.src = data.sprites.front_shiny || data.sprites.other['official-artwork'].front_shiny;
            await Promise.all([new Promise(r => normal.onload = r), new Promise(r => shiny.onload = r)]);
            pokemonData.push({ name: pName.charAt(0).toUpperCase() + pName.slice(1), images: { normal, shiny }, cry: data.cries ? data.cries.latest : null, id: data.id });
            pokemonColors.push(colors[i]);
        }
    } catch(e) { console.error(e); }
}

function initBoard() {
    resize();
    ensurePlayableBoard();
    lastMoveTime = Date.now();
    if (isShinyOnBoard()) playSparkle();
}

function ensurePlayableBoard() {
    let possible = false;
    while (!possible) {
        for (let r = 0; r < GRID_SIZE; r++) {
            board[r] = [];
            for (let c = 0; c < GRID_SIZE; c++) {
                board[r][c] = createTile(Math.floor(Math.random() * 6), false);
            }
        }
        if (findMatches().length === 0 && hasAnyMove()) possible = true;
    }
}

function createTile(id, allowSound = false) {
    const isShiny = Math.floor(Math.random() * SHINY_CHANCE) === 0;
    if (isShiny && allowSound) playSparkle();
    return { id, isShiny, xOffset: 0, yOffset: 0, isMatch: false, scale: 1, rotation: 0 };
}

// --- RENDERIZADO Y RESPONSIVIDAD ---

function resize() {
    // Calculamos el tama√±o basado en el contenedor o ventana
    const padding = 20;
    const availableWidth = window.innerWidth - padding;
    const availableHeight = window.innerHeight * 0.6; // M√°ximo 60% de la altura para dejar espacio a la UI
    
    const size = Math.min(availableWidth, availableHeight, 500); // M√°ximo 500px para que no se vea gigante en PC
    
    canvas.width = size;
    canvas.height = size;
    TILE_SIZE = size / GRID_SIZE;
}

function renderLoop() {
    if (gameScreen.style.display === 'none') { requestAnimationFrame(renderLoop); return; }
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Cuadr√≠cula de fondo
    ctx.strokeStyle = "#334155";
    ctx.lineWidth = 1;
    for(let i=0; i<=GRID_SIZE; i++) {
        ctx.beginPath(); ctx.moveTo(i*TILE_SIZE, 0); ctx.lineTo(i*TILE_SIZE, canvas.height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, i*TILE_SIZE); ctx.lineTo(canvas.width, i*TILE_SIZE); ctx.stroke();
    }

    for (let r = 0; r < GRID_SIZE; r++) {
        for (let c = 0; c < GRID_SIZE; c++) {
            const tile = board[r][c];
            if (tile.isMatch && tile.scale <= 0) continue;
            
            const drawX = c * TILE_SIZE + tile.xOffset;
            const drawY = r * TILE_SIZE + tile.yOffset;
            
            ctx.fillStyle = pokemonColors[tile.id];
            ctx.fillRect(drawX + 2, drawY + 2, TILE_SIZE - 4, TILE_SIZE - 4);
            
            if(tile.isShiny) {
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 3;
                ctx.strokeRect(drawX + 4, drawY + 4, TILE_SIZE - 8, TILE_SIZE - 8);
            }

            const pData = pokemonData[tile.id];
            if (pData) {
                const img = tile.isShiny ? pData.images.shiny : pData.images.normal;
                const displaySize = TILE_SIZE * tile.scale * 0.9;
                ctx.save();
                ctx.translate(drawX + TILE_SIZE/2, drawY + TILE_SIZE/2);
                ctx.rotate(tile.rotation);
                ctx.drawImage(img, -displaySize/2, -displaySize/2, displaySize, displaySize);
                ctx.restore();
            }
        }
    }
    requestAnimationFrame(renderLoop);
}

// --- INTERACCI√ìN ---

canvas.addEventListener('pointerdown', e => { 
    if (isAnimating || gameOver) return;
    e.preventDefault();
    canvas.setPointerCapture(e.pointerId);
    
    const rect = canvas.getBoundingClientRect();
    startX = e.clientX; startY = e.clientY;
    
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    // Guardamos la posici√≥n inicial de la celda
    canvas.dataset.startR = Math.floor(clickY / (rect.height / GRID_SIZE));
    canvas.dataset.startC = Math.floor(clickX / (rect.width / GRID_SIZE));
    lastMoveTime = Date.now();
});

canvas.addEventListener('pointerup', e => {
    if (isAnimating || gameOver || startX === null) return;
    
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    const threshold = 30; // Sensibilidad del swipe
    
    const r = parseInt(canvas.dataset.startR);
    const c = parseInt(canvas.dataset.startC);
    
    if (r >= 0 && r < GRID_SIZE && c >= 0 && c < GRID_SIZE) {
        let dir = null;
        if (Math.abs(dx) > Math.abs(dy)) {
            if (Math.abs(dx) > threshold) dir = dx > 0 ? 'right' : 'left';
        } else {
            if (Math.abs(dy) > threshold) dir = dy > 0 ? 'down' : 'up';
        }
        if (dir) moveTile(r, c, dir);
    }
    startX = startY = null;
});

// --- L√ìGICA DE MOVIMIENTO Y ANIMACI√ìN ---

async function moveTile(r, c, dir) {
    let tr = r, tc = c;
    if (dir === 'up') tr--; else if (dir === 'down') tr++; 
    else if (dir === 'left') tc--; else if (dir === 'right') tc++;
    
    if (tr >= 0 && tr < GRID_SIZE && tc >= 0 && tc < GRID_SIZE) {
        isAnimating = true;
        await animateSlide(r, c, tr, tc);
        
        const temp = { id: board[r][c].id, isShiny: board[r][c].isShiny };
        board[r][c].id = board[tr][tc].id; 
        board[r][c].isShiny = board[tr][tc].isShiny;
        board[tr][tc].id = temp.id; 
        board[tr][tc].isShiny = temp.isShiny;

        if (findMatches().length > 0) {
            await processMatches();
            saveGameState();
            if (!hasAnyMove()) endGame();
        } else {
            await animateSlide(r, c, tr, tc); // Deshacer movimiento
            const swapBack = { id: board[tr][tc].id, isShiny: board[tr][tc].isShiny };
            board[tr][tc].id = board[r][c].id; 
            board[tr][tc].isShiny = board[r][c].isShiny;
            board[r][c].id = swapBack.id; 
            board[r][c].isShiny = swapBack.isShiny;
        }
        isAnimating = false;
    }
}

async function animateSlide(r1, c1, r2, c2) {
    const duration = 200; const startTime = Date.now();
    const t1 = board[r1][c1]; const t2 = board[r2][c2];
    return new Promise(resolve => {
        function anim() {
            const progress = Math.min((Date.now() - startTime) / duration, 1);
            t1.xOffset = (c2 - c1) * TILE_SIZE * progress; 
            t1.yOffset = (r2 - r1) * TILE_SIZE * progress;
            t2.xOffset = (c1 - c2) * TILE_SIZE * progress; 
            t2.yOffset = (r1 - r2) * TILE_SIZE * progress;
            if (progress < 1) requestAnimationFrame(anim);
            else { t1.xOffset = t1.yOffset = t2.xOffset = t2.yOffset = 0; resolve(); }
        } anim();
    });
}

async function processMatches() {
    let matches = findMatches();
    while(matches.length > 0){
        matches.forEach(m => {
            const tile = board[m.r][m.c];
            if(tile.isShiny && !tile.isMatch) captureShiny(tile.id);
            tile.isMatch = true;
        });
        score += matches.length * 100;
        scoreEl.innerText = score;
        await animateShrink(matches);
        
        // L√≥gica de ca√≠da
        for (let c = 0; c < GRID_SIZE; c++) {
            let empty = 0;
            for (let r = GRID_SIZE - 1; r >= 0; r--) {
                if (board[r][c].isMatch) empty++;
                else if (empty > 0) {
                    board[r + empty][c] = { ...board[r][c], yOffset: -empty * TILE_SIZE, isMatch: false, scale: 1 };
                    board[r][c].isMatch = true;
                }
            }
            for (let r = 0; r < empty; r++) {
                board[r][c] = createTile(Math.floor(Math.random() * 6), true);
                board[r][c].yOffset = -empty * TILE_SIZE;
            }
        }
        await animateFalling();
        matches = findMatches();
    }
}

async function animateShrink(matches) {
    const duration = 250; const startTime = Date.now();
    return new Promise(resolve => {
        function anim() {
            const progress = Math.min((Date.now() - startTime) / duration, 1);
            matches.forEach(m => { 
                board[m.r][m.c].scale = 1 - progress; 
            });
            if (progress < 1) requestAnimationFrame(anim); else resolve();
        } anim();
    });
}

async function animateFalling() {
    const duration = 300; const startTime = Date.now();
    return new Promise(resolve => {
        function anim() {
            const progress = Math.min((Date.now() - startTime) / duration, 1);
            let stillMoving = false;
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (board[r][c].yOffset < 0) {
                        board[r][c].yOffset += (TILE_SIZE * 0.12);
                        if (board[r][c].yOffset > 0) board[r][c].yOffset = 0;
                        stillMoving = true;
                    }
                }
            }
            if (stillMoving) requestAnimationFrame(anim); else resolve();
        } anim();
    });
}

// --- UTILIDADES RESTANTES ---

function findMatches() {
    let matches = [];
    for (let r = 0; r < GRID_SIZE; r++) {
        for (let c = 0; c < GRID_SIZE - 2; c++) {
            if (board[r][c].id === board[r][c+1].id && board[r][c].id === board[r][c+2].id) 
                matches.push({r, c}, {r, c:c+1}, {r, c:c+2});
        }
    }
    for (let c = 0; c < GRID_SIZE; c++) {
        for (let r = 0; r < GRID_SIZE - 2; r++) {
            if (board[r][c].id === board[r+1][c].id && board[r][c].id === board[r+2][c].id) 
                matches.push({r, c}, {r:r+1, c}, {r:r+2, c});
        }
    }
    return matches;
}

function hasAnyMove() {
    for (let r = 0; r < GRID_SIZE; r++) {
        for (let c = 0; c < GRID_SIZE; c++) {
            if (c < GRID_SIZE - 1 && checkPotential(r, c, r, c + 1)) return true;
            if (r < GRID_SIZE - 1 && checkPotential(r, c, r + 1, c)) return true;
        }
    }
    return false;
}

function checkPotential(r1, c1, r2, c2) {
    const t1 = board[r1][c1].id; board[r1][c1].id = board[r2][c2].id; board[r2][c2].id = t1;
    const matches = findMatches();
    board[r2][c2].id = board[r1][c1].id; board[r1][c1].id = t1;
    return matches.length > 0;
}

function captureShiny(tileId) {
    const pInfo = pokemonData[tileId];
    if (!caughtShinies[pInfo.id]) { 
        caughtShinies[pInfo.id] = pInfo.images.shiny.src; 
        localStorage.setItem('shinyDex', JSON.stringify(caughtShinies)); 
    }
    const img = document.createElement('img'); img.src = pInfo.images.shiny.src; img.className = 'shiny-icon';
    shinyListEl.appendChild(img); finalShinyListEl.appendChild(img.cloneNode());
}

function isShinyOnBoard() { return board.some(row => row.some(tile => tile.isShiny && !tile.isMatch)); }
function playSparkle() { if (!isMuted) { SHINY_SOUND.currentTime = 0; SHINY_SOUND.play().catch(()=>{}); } }
function resetToMenu() { gameScreen.style.display = 'none'; mainMenu.style.display = 'block'; checkSaveFile(); }
function endGame() { gameOver = true; finalScoreEl.innerText = score; gameOverOverlay.style.display = 'flex'; localStorage.removeItem('shinyMatchSave'); checkSaveFile(); }

async function startGame() {
    mainMenu.style.display = 'none'; gameOverOverlay.style.display = 'none'; gameScreen.style.display = 'flex'; loadingEl.style.display = 'flex';
    pokemonData = []; pokemonColors = []; sparkles = []; score = 0; scoreEl.innerText = "0"; gameOver = false;
    shinyListEl.innerHTML = ""; finalShinyListEl.innerHTML = "";
    await fetchGameData();
    if (pokemonData.length > 0) {
        initBoard(); loadingEl.style.display = 'none';
        if(!gameInitialized) { gameInitialized = true; requestAnimationFrame(renderLoop); setInterval(checkIdleTime, 1000); }
    } else { alert("Error loading Pok√©mon."); resetToMenu(); }
}

function checkIdleTime() {} 
function openDex() {
    dexGrid.innerHTML = ""; dexCount.innerText = `COLLECTED: ${Object.keys(caughtShinies).length}`;
    for (let i = 1; i <= 1025; i++) dexGrid.appendChild(createDexSlot(i));
    dexModal.style.display = 'flex';
}
function createDexSlot(id) {
    const slot = document.createElement('div'); slot.className = 'dex-slot';
    const img = document.createElement('img');
    if (caughtShinies[id]) img.src = caughtShinies[id];
    else { img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`; slot.classList.add('not-caught'); }
    slot.appendChild(img); return slot;
}
function closeModals() {
    howModal.style.display = 'none';
    dexModal.style.display = 'none';
    whoModal.style.display = 'none';
}
function toggleMute() { isMuted = !isMuted; muteBtn.innerText = isMuted ? 'üîá' : 'üîä'; }

window.addEventListener('resize', () => { resize(); });
window.addEventListener('load', checkSaveFile);
</script>
</body>
</html>


